# Backtesting and Reporting

The `backtesting/` directory contains scripts for evaluating the performance of trading strategies using historical data. This process is crucial for understanding a strategy's potential viability before deploying it in a live market.

## 1. Backtesting a Single Strategy (`backtesting/run_backtest.py`)

### Purpose
The `run_backtest.py` script provides a "deep dive" into a single strategy's performance against a specific dataset. It is designed to be run from the command line and produces a detailed report and an interactive plot of the results.

### Design and Logic
1.  **Argument Parsing**: The script uses Python's `argparse` module to allow the user to specify the strategy, data file, initial cash, and commission rate from the command line. This makes the script flexible and easy to use in different scenarios without modifying the code.

2.  **Indicator Pre-calculation**:
    -   **Rationale**: A key design decision was to pre-calculate technical indicators *before* running the backtest, rather than calculating them inside the strategy with `self.I()`. The initial implementation using `self.I()` failed because it passes a custom `_Array` object (a numpy wrapper) to the indicator function, which is incompatible with pandas-native functions like `.rolling()`.
    -   **Implementation**: The script now uses the `pandas-ta` library to calculate the necessary indicators (e.g., SMA) and append them as new columns to the data `DataFrame`. This `DataFrame`, now containing both the OHLCV data and the indicator values, is then passed to the `Backtest` object. The strategy class then simply accesses these pre-calculated columns. This pattern is more robust and avoids potential conflicts between the backtesting library's internal data format and the indicator calculation libraries.

3.  **Backtest Execution**:
    -   An instance of the `backtesting.Backtest` class is created, providing it with the data (including indicators), the strategy class, initial cash, and a commission rate. The commission rate is set to `0.005` (0.5%) by default, as specified in the project requirements, to simulate realistic trading costs.

4.  **Detailed Report Generation**:
    -   **Motivation**: Simply printing stats to the console is ephemeral. To properly track performance and compare runs, a persistent and detailed report is necessary.
    -   **Implementation**: After a backtest is run, the script now generates two files:
        1.  **An HTML plot**: An interactive chart showing the equity curve, buy/sell markers, and indicator overlays.
        2.  **A Markdown (`.md`) Report**: A text-based report that includes:
            -   The name of the strategy and a timestamp.
            -   The parameters used by the strategy (e.g., MA periods).
            -   A table of the performance metrics (Return, Sharpe Ratio, Max. Drawdown, etc.). This is generated by filtering the internal (`_`) values from the `stats` object and using the `.to_markdown()` method, which requires the `tabulate` library.
            -   A relative link to the corresponding HTML plot for easy reference.
    -   This dual-report format provides both a quick visual overview and a detailed, archivable summary of the backtest.
